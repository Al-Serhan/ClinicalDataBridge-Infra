name: Infrastructure Quality & Security Checks

on:
  pull_request:
    paths:
      - 'terraform/**'
      - '.pre-commit-config.yaml'
      - '.tflint.hcl'
      - '.github/workflows/**'
  push:
    branches:
      - main
      - feat-*
    paths:
      - 'terraform/**'

# NOTE: As solo developer, these checks are informational
# When team grows, make these required status checks in branch protection

jobs:
  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.6.0

      - name: Terraform Format Check
        run: |
          tofu fmt -check -recursive terraform/
        continue-on-error: true

      - name: Validate Dev Environment
        run: |
          cd terraform/environments/dev
          tofu init -backend=false
          tofu validate

      - name: Validate Prod Environment
        run: |
          cd terraform/environments/prod
          tofu init -backend=false
          tofu validate

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: 'terraform/'
          soft_fail: true
          format: 'sarif'
          github_token: ${{ secrets.GITHUB_TOKEN }}
          additional_args: --config-file=../.tfsec.yml
        continue-on-error: true

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: terraform/
          framework: terraform
          soft_fail: true
          output_format: cli
          download_external_modules: false
        continue-on-error: true

      # Note: SARIF upload disabled - tfsec results visible in job logs
      # GitHub Code Scanning can be enabled later if needed

  linting:
    name: Terraform Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Initialize TFLint
        run: tflint --init
        continue-on-error: true

      - name: Run TFLint
        run: |
          cd terraform/environments/dev
          tflint --minimum-failure-severity=error
        continue-on-error: true

  documentation-check:
    name: Documentation Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README exists
        run: |
          if [ ! -f README.md ]; then
            echo "ERROR: README.md is missing"
            exit 1
          fi

      - name: Check for sensitive data
        run: |
          # Check for common sensitive patterns
          if grep -rE "(aws_access_key|aws_secret_key|password\s*=|private_key)" terraform/ --exclude-dir=.terraform; then
            echo "ERROR: Potential sensitive data found in terraform files"
            exit 1
          fi

      - name: Validate tfvars examples
        run: |
          if [ ! -f terraform/environments/dev/terraform.tfvars ]; then
            echo "WARNING: Dev tfvars not found"
          fi

  cost-estimate:
    name: Infrastructure Cost Estimate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Infracost
        uses: infracost/actions/setup@v2
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Generate cost estimate
        if: github.event_name == 'pull_request'
        run: |
          echo "Cost estimation requires Infracost API key"
          echo "To enable: Add INFRACOST_API_KEY to repository secrets"
        continue-on-error: true

  summary:
    name: Checks Summary
    runs-on: ubuntu-latest
    needs: [terraform-validate, security-scan, linting, documentation-check]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "==================================="
          echo "Infrastructure Checks Summary"
          echo "==================================="
          echo ""
          echo "Terraform Validation: ${{ needs.terraform-validate.result }}"
          echo "Security Scanning: ${{ needs.security-scan.result }}"
          echo "Linting: ${{ needs.linting.result }}"
          echo "Documentation: ${{ needs.documentation-check.result }}"
          echo ""
          echo "==================================="

          # Informational only - don't block as solo developer
          if [ "${{ needs.terraform-validate.result }}" != "success" ]; then
            echo "Note: Some checks had issues (see logs above)"
          else
            echo "All critical checks passed"
          fi